<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daniel Carrera</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="styles.css?v=56">
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
    <div class="page-flash"></div>
    <canvas id="constellation-bg"></canvas>
    <model-viewer
        id="hero-model"
        src="timeless-gaze-compressed.glb"
        alt="3D Model"
        loading="eager"
        reveal="auto"
        camera-orbit="0deg 90deg auto"
        camera-target="0m 0.15m 0m"
        interaction-prompt="none"
        disable-zoom
        disable-pan
        shadow-intensity="0"
        style="background: transparent !important;"
        class="hero-model"
    ></model-viewer>
    <div id="model-click-overlay"></div>
    <canvas id="constellation-fg"></canvas>
    <nav>
        <a href="/" class="nav-name">
            <img src="logo.png" alt="Logo" class="nav-logo">
            Daniel Carrera
        </a>
        <div class="nav-links" id="nav-links">
            <a href="/art.html" id="nav-art">Art</a>
            <a href="/literature.html" id="nav-literature">Literature</a>
            <a href="/music.html" id="nav-music">Music</a>
            <a href="/software.html" id="nav-software">Software</a>
            <a href="/hardware.html" id="nav-hardware">Hardware</a>
            <a href="/textiles.html" id="nav-textiles">Textiles</a>
        </div>
        <script>
            (function() {
                const SETTINGS_KEY = 'site_settings';
                const settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
                const navContainer = document.getElementById('nav-links');

                const navItems = [
                    { id: 'nav-art', key: 'art', showKey: 'showArtNav' },
                    { id: 'nav-literature', key: 'literature', showKey: 'showLiteratureNav' },
                    { id: 'nav-music', key: 'music', showKey: 'showMusicNav' },
                    { id: 'nav-software', key: 'software', showKey: 'showSoftwareNav' },
                    { id: 'nav-hardware', key: 'hardware', showKey: 'showHardwareNav' },
                    { id: 'nav-textiles', key: 'textiles', showKey: 'showTextilesNav' }
                ];

                // Apply visibility
                navItems.forEach(({ id, showKey }) => {
                    const el = document.getElementById(id);
                    if (settings[showKey] === false) {
                        el.style.display = 'none';
                    }
                });

                // Apply nav order
                if (settings.navOrder && navContainer) {
                    settings.navOrder.forEach(key => {
                        const el = document.getElementById('nav-' + key);
                        if (el) navContainer.appendChild(el);
                    });
                }

                // Reposition visible items evenly around circle
                const visibleItems = Array.from(navContainer.querySelectorAll('a')).filter(el => el.style.display !== 'none');
                const radius = window.innerWidth >= 768 ? 250 : 180;
                const count = visibleItems.length;

                visibleItems.forEach((el, i) => {
                    const angle = -90 + (i * (360 / count)); // Start from top, distribute evenly
                    el.style.transform = `translate(-50%, -50%) rotate(${angle}deg) translateX(${radius}px) rotate(90deg)`;
                });

                // Store for resize handling
                window.repositionNav = function() {
                    const r = window.innerWidth >= 768 ? 250 : 180;
                    visibleItems.forEach((el, i) => {
                        const angle = -90 + (i * (360 / count));
                        el.style.transform = `translate(-50%, -50%) rotate(${angle}deg) translateX(${r}px) rotate(90deg)`;
                    });
                };
                window.addEventListener('resize', window.repositionNav);
            })();
        </script>
    </nav>

    <main>
        <section class="hero">
            <h1>Daniel Carrera</h1>
            <p class="hero-subtitle">polymath</p>
        </section>

        <section class="latest-blog" id="latest-blog-section">
            <h2 id="latest-section-heading">Latest</h2>
            <div id="latest-post-container"></div>
        </section>
        <script>
            (function() {
                const STORAGE_KEY = 'literature_posts';
                const SETTINGS_KEY = 'site_settings';
                const defaultPosts = [
                    { id: 'default_3', type: 'post', title: 'Your First Blog Post', date: '2026-01-23', content: 'This is where your blog post excerpt will appear. Write about anything that interests you.', link: '#' }
                ];

                // Placeholder content for each page source
                const pageContent = {
                    literature: { getContent: getLatestPost, link: '/literature.html' },
                    art: { title: 'Featured Artwork', description: 'Explore the latest visual creations.', link: '/art.html' },
                    music: { title: 'Latest Track', description: 'Listen to the newest musical composition.', link: '/music.html' },
                    software: { title: 'New Release', description: 'Check out the latest software project.', link: '/software.html' },
                    hardware: { title: 'Hardware Project', description: 'See the latest hardware creation.', link: '/hardware.html' },
                    textiles: { title: 'Textile Design', description: 'View the newest textile work.', link: '/textiles.html' }
                };

                // Build link with section target
                function buildLink(baseLink, target, source) {
                    if (!target) return baseLink;
                    // For literature filter tabs
                    if (source === 'literature' && ['essay', 'meditation', 'post'].includes(target)) {
                        return baseLink + '?filter=' + target;
                    }
                    // For section IDs or 'latest' marker
                    return baseLink + '#' + target;
                }

                function getSettings() {
                    const data = localStorage.getItem(SETTINGS_KEY);
                    return data ? JSON.parse(data) : { showLatestSection: true, latestSectionTitle: 'Latest', latestSource: 'literature' };
                }

                function formatDate(dateStr) {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                }

                function getLatestPost() {
                    const data = localStorage.getItem(STORAGE_KEY);
                    const posts = data ? JSON.parse(data) : defaultPosts;

                    for (const post of posts) {
                        const visibility = post.visibility || 'visible';
                        if (visibility === 'hidden') continue;
                        if (visibility === 'scheduled' && post.publishDate && new Date(post.publishDate) > new Date()) continue;
                        if (post.type !== 'meditation') return post;
                    }
                    return null;
                }

                const settings = getSettings();
                const section = document.getElementById('latest-blog-section');
                const heading = document.getElementById('latest-section-heading');
                const container = document.getElementById('latest-post-container');
                const source = settings.latestSource || 'literature';
                const sectionTarget = settings.latestSectionTarget || '';

                if (settings.showLatestSection === false) {
                    section.style.display = 'none';
                    return;
                }

                heading.textContent = settings.latestSectionTitle || 'Latest';

                // Get content based on source
                if (source === 'literature') {
                    const post = getLatestPost();
                    if (post) {
                        const isComingSoon = post.visibility === 'coming_soon';
                        const link = buildLink('/literature.html', sectionTarget, source);
                        container.innerHTML = `
                            <a href="${link}" class="blog-preview-card${isComingSoon ? ' content-coming-soon' : ''}">
                                <time datetime="${post.date}">${formatDate(post.date)}</time>
                                <h3>${post.title}</h3>
                                <p>${post.content}</p>
                            </a>
                        `;
                    } else {
                        section.style.display = 'none';
                    }
                } else {
                    const content = pageContent[source];
                    if (content) {
                        const link = buildLink(content.link, sectionTarget, source);
                        container.innerHTML = `
                            <a href="${link}" class="blog-preview-card">
                                <h3>${content.title}</h3>
                                <p>${content.description}</p>
                            </a>
                        `;
                    }
                }
            })();
        </script>

        <section class="featured-media" id="art-section">
            <h2>Art</h2>
            <a href="/art.html" class="art-grid">
                <div class="art-col art-col-video">
                    <div class="art-item art-video"></div>
                </div>
                <div class="art-col art-col-2">
                    <div class="art-item"></div>
                    <div class="art-item"></div>
                </div>
                <div class="art-col art-col-3">
                    <div class="art-item"></div>
                    <div class="art-item"></div>
                    <div class="art-item"></div>
                </div>
            </a>
        </section>

        <section class="homepage-section" id="hardware-section">
            <h2>Hardware</h2>
            <a href="/hardware.html" class="blog-preview-card">
                <h3>Hardware Projects</h3>
                <p>Explore physical creations and builds.</p>
            </a>
        </section>

        <section class="homepage-section" id="literature-section">
            <h2>Literature</h2>
            <a href="/literature.html" class="blog-preview-card">
                <h3>Writing & Essays</h3>
                <p>Articles, reflections, and tangents.</p>
            </a>
        </section>

        <section class="homepage-section" id="music-section">
            <h2>Music</h2>
            <a href="/music.html" class="blog-preview-card">
                <h3>Original Compositions</h3>
                <p>Listen to original music tracks.</p>
            </a>
        </section>

        <section class="projects" id="software-section">
            <h2>Software</h2>
            <div class="project-grid" id="software-grid"></div>
        </section>
        <script>
            (function() {
                const APPS_KEY = 'software_apps';
                const defaultApps = [
                    { id: 'app_1', name: 'Tiempo', subtitle: 'AI-Daily Planner for iOS and macOS', icon: 'icon-tiempo.png', link: '/software.html#tiempo', status: 'available' },
                    { id: 'app_2', name: 'Synesthesia', subtitle: 'VisionOS app for experiencing music visually', icon: 'icon-synesthesia.png', link: '/software.html#synesthesia', status: 'coming_soon' },
                    { id: 'app_3', name: 'Arrow', subtitle: 'VisionOS app for Spatial Messaging', icon: 'icon-arrow.png', link: '/software.html#arrow', status: 'coming_soon' }
                ];

                function getApps() {
                    const data = localStorage.getItem(APPS_KEY);
                    return data ? JSON.parse(data) : defaultApps;
                }

                const apps = getApps().filter(app => app.status !== 'hidden');
                const grid = document.getElementById('software-grid');

                // Add class for full-width when 1-2 cards
                if (apps.length <= 2) {
                    grid.classList.add('few-cards');
                }

                grid.innerHTML = apps.map(app => {
                    const isComingSoon = app.status === 'coming_soon';
                    const cardClass = app.name ? `card-${app.name.toLowerCase()}` : '';
                    const appLink = app.name ? `/software.html#${app.name.toLowerCase()}` : '/software.html';

                    if (isComingSoon) {
                        return `
                            <div class="project-card ${cardClass} content-coming-soon">
                                <img src="${app.icon || 'icon-default.png'}" alt="${app.name}" class="project-icon-img">
                                <h3>${app.name}</h3>
                                <p>Coming Soon</p>
                            </div>
                        `;
                    }

                    return `
                        <a href="${appLink}" class="project-card ${cardClass}">
                            <img src="${app.icon || 'icon-default.png'}" alt="${app.name}" class="project-icon-img">
                            <h3>${app.name}</h3>
                            <p>${app.subtitle || ''}</p>
                        </a>
                    `;
                }).join('');
            })();
        </script>

        <section class="homepage-section" id="textiles-section">
            <h2>Textiles</h2>
            <a href="/textiles.html" class="blog-preview-card">
                <h3>Textile Work</h3>
                <p>Fabric designs and creations.</p>
            </a>
        </section>

        <script>
            (function() {
                const SETTINGS_KEY = 'site_settings';
                function getSettings() {
                    const data = localStorage.getItem(SETTINGS_KEY);
                    return data ? JSON.parse(data) : {};
                }
                const settings = getSettings();

                // All homepage sections
                const sections = ['latest', 'art', 'hardware', 'literature', 'music', 'software', 'textiles'];

                // Apply visibility
                sections.forEach(key => {
                    const section = document.getElementById(key === 'latest' ? 'latest-blog-section' : `${key}-section`);
                    const showKey = `show${key.charAt(0).toUpperCase() + key.slice(1)}Section`;
                    if (section && settings[showKey] === false) {
                        section.style.display = 'none';
                    }
                });

                // Apply section order
                if (settings.sectionOrder) {
                    const main = document.querySelector('main');
                    const sectionMap = {};
                    sections.forEach(key => {
                        sectionMap[key] = document.getElementById(key === 'latest' ? 'latest-blog-section' : `${key}-section`);
                    });

                    // Reorder sections after hero
                    settings.sectionOrder.forEach(key => {
                        const section = sectionMap[key];
                        if (section) {
                            main.appendChild(section);
                        }
                    });
                }
            })();
        </script>
    </main>

    <footer>
        <p>&copy; 2026 Daniel Carrera</p>
    </footer>
    <script src="animation.js?v=20"></script>
    <script>
        // Page transition flash effect
        document.querySelectorAll('nav a').forEach(link => {
            function navigate(e) {
                e.preventDefault();
                if (link.href && !link.href.includes('#')) {
                    const flash = document.querySelector('.page-flash');
                    flash.classList.add('active');
                    setTimeout(() => {
                        window.location.href = link.href;
                    }, 150);
                }
            }
            link.addEventListener('click', navigate);
            link.addEventListener('touchend', navigate);
        });
    </script>
    <script>
        // Figure-8 infinity motion for 3D model with mouse tracking and drag control
        const heroModel = document.getElementById('hero-model');
        const clickOverlay = document.getElementById('model-click-overlay');
        if (heroModel && clickOverlay) {
            const duration = 20000; // 20 seconds for full infinity loop
            let scrollScale = 1;
            let mouseRotation = 0;
            let mouseTilt = 0;
            let isPaused = false;
            let isDragging = false;
            let dragStartX = 0;
            let dragStartY = 0;
            let dragRotation = 0;
            let dragTilt = 90;
            let pausedMoveX = 0;
            let pausedMoveY = 0;
            let pausedNodScale = 1;  // Just the nod scale, multiply by scrollScale when rendering

            // Nav hover state - freezes figure-8 rotation but keeps scale
            let navHovered = false;
            let frozenRotation = 0;
            let frozenTilt = 90;
            let frozenMoveX = 0;
            let frozenMoveY = 0;
            let scaleTime = 0; // Separate time for scale animation
            let currentScaleSpeed = 1;
            let targetScaleSpeed = 1;
            let rotationTime = 0; // Time for rotation animation (moved up for click handler access)

            // Update scale based on scroll position
            function updateScrollScale() {
                const scrollY = window.scrollY;
                // Start at 1.3, grow gradually without max cap
                scrollScale = 1.3 + (scrollY / 500) * 0.4;
            }

            // Track mouse position relative to model center (only when not paused)
            function updateMousePosition(e) {
                if (isPaused || isDragging) return;
                const rect = heroModel.getBoundingClientRect();
                const modelCenterX = rect.left + rect.width / 2;
                const modelCenterY = rect.top + rect.height / 2;
                const deltaX = e.clientX - modelCenterX;
                const deltaY = e.clientY - modelCenterY;
                mouseRotation = Math.atan2(deltaX, 300) * (180 / Math.PI) * -1;
                mouseTilt = Math.atan2(deltaY, 300) * (180 / Math.PI) * -1;
            }

            // Listen for nav link hover
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.addEventListener('mouseenter', () => {
                    navHovered = true;
                    window.navSlowMotion = true; // Global flag for constellation
                    targetScaleSpeed = 0.3; // Slow scale animation
                });
                link.addEventListener('mouseleave', () => {
                    navHovered = false;
                    window.navSlowMotion = false;
                    targetScaleSpeed = 1; // Resume normal speed
                });
            });

            // Pointer event handlers for click and drag (on overlay)
            let clickStartX = 0;
            let clickStartY = 0;
            let pointerId = null;

            clickOverlay.addEventListener('pointerdown', (e) => {
                clickStartX = e.clientX;
                clickStartY = e.clientY;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                pointerId = e.pointerId;
                clickOverlay.setPointerCapture(e.pointerId);
            });

            clickOverlay.addEventListener('pointermove', (e) => {
                if (pointerId === null) return;

                const dx = Math.abs(e.clientX - clickStartX);
                const dy = Math.abs(e.clientY - clickStartY);

                // Start dragging if moved more than 5px and paused
                if (isPaused && (dx > 5 || dy > 5)) {
                    isDragging = true;
                    clickOverlay.style.cursor = 'grabbing';
                }

                if (isDragging) {
                    const deltaX = e.clientX - dragStartX;
                    const deltaY = e.clientY - dragStartY;
                    dragRotation -= deltaX * 0.5;
                    dragTilt = Math.max(45, Math.min(135, dragTilt - deltaY * 0.5));  // Fixed inversion
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    heroModel.setAttribute('camera-orbit', `${dragRotation}deg ${dragTilt}deg auto`);
                }
            });

            clickOverlay.addEventListener('pointerup', (e) => {
                const dx = Math.abs(e.clientX - clickStartX);
                const dy = Math.abs(e.clientY - clickStartY);

                // If it was a click (not a drag)
                if (dx < 5 && dy < 5) {
                    isPaused = !isPaused;
                    if (isPaused) {
                        // Capture exact current position from rotationTime
                        const t = (rotationTime / duration) * Math.PI * 2;
                        const baseRotation = Math.sin(t) * 25;
                        const tiltOffset = Math.sin(t * 2);
                        const baseTilt = 80 + tiltOffset * 10;
                        dragRotation = baseRotation + mouseRotation;
                        dragTilt = baseTilt + mouseTilt;
                        // Capture transform values
                        pausedMoveX = Math.sin(t) * 10;
                        pausedMoveY = Math.sin(t * 2) * 4;
                        pausedNodScale = 1 + tiltOffset * 0.15;
                        clickOverlay.style.cursor = 'grab';
                    } else {
                        clickOverlay.style.cursor = 'pointer';
                    }
                }

                isDragging = false;
                pointerId = null;
                clickOverlay.style.cursor = isPaused ? 'grab' : 'pointer';
                try { clickOverlay.releasePointerCapture(e.pointerId); } catch(err) {}
            });

            window.addEventListener('scroll', updateScrollScale, { passive: true });
            window.addEventListener('mousemove', updateMousePosition, { passive: true });
            updateScrollScale();

            let lastTimestamp = null;
            let wasHovered = false;

            function animateRotation(timestamp) {
                if (!lastTimestamp) lastTimestamp = timestamp;
                const deltaTime = timestamp - lastTimestamp;
                lastTimestamp = timestamp;

                // Smoothly interpolate scale speed
                currentScaleSpeed += (targetScaleSpeed - currentScaleSpeed) * 0.05;

                // Scale time always advances (at varying speed)
                scaleTime += deltaTime * currentScaleSpeed;

                if (!isPaused) {
                    // Rotation time only advances when not hovering nav
                    if (!navHovered) {
                        rotationTime += deltaTime;
                    }

                    // Capture frozen position when entering hover
                    if (navHovered && !wasHovered) {
                        const t = (rotationTime / duration) * Math.PI * 2;
                        frozenRotation = Math.sin(t) * 25 + mouseRotation;
                        frozenTilt = 80 + Math.sin(t * 2) * 10 + mouseTilt;
                        frozenMoveX = Math.sin(t) * 10;
                        frozenMoveY = Math.sin(t * 2) * 4;
                    }
                    wasHovered = navHovered;

                    // Calculate scale from its own time
                    const scaleT = (scaleTime / duration) * Math.PI * 2;
                    const tiltOffset = Math.sin(scaleT * 2);
                    const nodScale = 1 + tiltOffset * 0.15;
                    const totalScale = nodScale * scrollScale;

                    // Share breathing scale with nav circle
                    window.breathScale = 1 + tiltOffset * 0.08; // Subtler for nav

                    if (navHovered) {
                        // Rotation frozen, scale animates
                        heroModel.setAttribute('camera-orbit', `${frozenRotation}deg ${frozenTilt}deg auto`);
                        heroModel.style.transform = `translate(calc(-50% + ${frozenMoveX}px), calc(-50% + ${frozenMoveY}px)) scale(${totalScale})`;
                    } else {
                        // Normal figure-8 animation
                        const t = (rotationTime / duration) * Math.PI * 2;
                        const baseRotation = Math.sin(t) * 25;
                        const baseTilt = 80 + Math.sin(t * 2) * 10;
                        const rotation = baseRotation + mouseRotation;
                        const tilt = baseTilt + mouseTilt;
                        const moveX = Math.sin(t) * 10;
                        const moveY = Math.sin(t * 2) * 4;

                        heroModel.setAttribute('camera-orbit', `${rotation}deg ${tilt}deg auto`);
                        heroModel.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px)) scale(${totalScale})`;
                    }
                } else {
                    // When paused, maintain position but allow scroll scale to update
                    const totalScale = pausedNodScale * scrollScale;
                    heroModel.style.transform = `translate(calc(-50% + ${pausedMoveX}px), calc(-50% + ${pausedMoveY}px)) scale(${totalScale})`;
                }

                requestAnimationFrame(animateRotation);
            }

            requestAnimationFrame(animateRotation);
        }
    </script>
</body>
</html>
