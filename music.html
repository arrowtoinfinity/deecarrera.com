<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music - Daniel Carrera</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="page-flash"></div>
    <canvas id="constellation-bg"></canvas>
    <canvas id="constellation-fg"></canvas>
    <nav>
        <a href="/" class="nav-name">
            <img src="logo.png" alt="Logo" class="nav-logo">
            Daniel Carrera
        </a>
        <div class="nav-links">
            <a href="/art.html">Art</a>
            <a href="/literature.html">Literature</a>
            <a href="/music.html" class="active">Music</a>
            <a href="/software.html">Software</a>
            <a href="/textiles.html">Textiles</a>
        </div>
    </nav>

    <main>
        <section class="page-header">
            <h1>Music</h1>
        </section>

        <section class="music-list">
            <article class="music-card vertical">
                <button class="play-btn" id="play-btn">
                    <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                </button>
                <h2>Infinitum</h2>
                <audio id="music-player" crossorigin="anonymous">
                    <source src="Infinitum.wav" type="audio/wav">
                </audio>
            </article>
        </section>
    </main>

    <footer>
        <p>&copy; 2026 Daniel Carrera</p>
    </footer>
    <script src="animation.js"></script>
    <script>
        // Audio Visualizer - uses buffer-based approach to avoid SES/extension conflicts
        (function() {
            const playBtn = document.getElementById('play-btn');
            const playIcon = playBtn.querySelector('.play-icon');
            const pauseIcon = playBtn.querySelector('.pause-icon');
            const audioElement = document.getElementById('music-player');

            let audioContext = null;
            let analyser = null;
            let bufferSource = null;
            let audioBuffer = null;
            let dataArray = null;
            let isPlaying = false;
            let isLoading = false;
            let startTime = 0;
            let pauseTime = 0;

            // Pre-initialize audioData
            window.audioData = { bass: 0, mids: 0, treble: 0, active: false };

            // Load audio file as buffer (bypasses SES restrictions)
            async function loadAudioBuffer() {
                if (audioBuffer) return audioBuffer;

                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!audioContext) {
                    audioContext = new AudioContextClass();
                }

                // Fetch the audio file
                const response = await fetch('Infinitum.wav');
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                console.log('Audio buffer loaded, duration:', audioBuffer.duration);

                // Setup analyser
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.7;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                return audioBuffer;
            }

            // Start audio analysis loop
            function startAnalysisLoop() {
                function updateAudioData() {
                    if (!isPlaying || !analyser) {
                        window.audioData.active = false;
                        return;
                    }

                    analyser.getByteFrequencyData(dataArray);

                    const bass = dataArray.slice(0, 10).reduce((a, b) => a + b, 0) / 10;
                    const mids = dataArray.slice(10, 80).reduce((a, b) => a + b, 0) / 70;
                    const treble = dataArray.slice(80, 128).reduce((a, b) => a + b, 0) / 48;

                    window.audioData = {
                        bass: bass,
                        mids: mids,
                        treble: treble,
                        active: true
                    };

                    if (Math.random() < 0.01) {
                        console.log('Audio data:', bass.toFixed(1), mids.toFixed(1), treble.toFixed(1));
                    }

                    requestAnimationFrame(updateAudioData);
                }
                updateAudioData();
            }

            // Play audio
            async function playAudio() {
                if (isLoading) return;
                isLoading = true;

                try {
                    await loadAudioBuffer();

                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }

                    // Create new buffer source (required for each play)
                    bufferSource = audioContext.createBufferSource();
                    bufferSource.buffer = audioBuffer;
                    bufferSource.connect(analyser);
                    analyser.connect(audioContext.destination);

                    // Handle end of audio
                    bufferSource.onended = () => {
                        if (isPlaying) {
                            isPlaying = false;
                            pauseTime = 0;
                            window.audioData.active = false;
                            playIcon.style.display = 'block';
                            pauseIcon.style.display = 'none';
                        }
                    };

                    // Start from pause position
                    bufferSource.start(0, pauseTime);
                    startTime = audioContext.currentTime - pauseTime;
                    isPlaying = true;

                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';

                    startAnalysisLoop();
                    isLoading = false;
                    console.log('Playing from:', pauseTime.toFixed(2));
                } catch (err) {
                    console.error('Play error:', err);
                    isLoading = false;
                }
            }

            // Pause audio
            function pauseAudio() {
                // Always update UI first
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                window.audioData.active = false;

                if (bufferSource) {
                    try {
                        pauseTime = audioContext.currentTime - startTime;
                        bufferSource.stop();
                        bufferSource.disconnect();
                    } catch (e) {
                        // Already stopped
                    }
                    bufferSource = null;
                }
                isPlaying = false;
                console.log('Paused at:', pauseTime.toFixed(2));
            }

            // Toggle play/pause
            playBtn.addEventListener('click', () => {
                if (isPlaying) {
                    pauseAudio();
                } else {
                    playAudio();
                }
            });
        })();
    </script>
    <script>
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.href && !this.href.includes('#')) {
                    e.preventDefault();
                    document.querySelector('.page-flash').classList.add('active');
                    setTimeout(() => { window.location.href = this.href; }, 150);
                }
            });
        });
    </script>
</body>
</html>
