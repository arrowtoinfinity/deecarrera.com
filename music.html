<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music - Daniel Carrera</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="page-flash"></div>
    <canvas id="constellation-bg"></canvas>
    <canvas id="constellation-fg"></canvas>
    <nav>
        <a href="/" class="nav-name">
            <img src="logo.png" alt="Logo" class="nav-logo">
            Daniel Carrera
        </a>
        <div class="nav-links">
            <a href="/art.html">Art</a>
            <a href="/literature.html">Literature</a>
            <a href="/music.html" class="active">Music</a>
            <a href="/software.html">Software</a>
            <a href="/textiles.html">Textiles</a>
        </div>
    </nav>

    <main>
        <section class="page-header">
            <h1>Music</h1>
        </section>

        <section class="music-list">
            <article class="music-card vertical">
                <button class="play-btn" id="play-btn">
                    <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                </button>
                <h2>Infinitum</h2>
                <audio id="music-player" crossorigin="anonymous">
                    <source src="Infinitum.wav" type="audio/wav">
                </audio>
            </article>
        </section>
    </main>

    <footer>
        <p>&copy; 2026 Daniel Carrera</p>
    </footer>
    <script src="animation.js"></script>
    <script>
        // Audio Visualizer - makes constellation nodes react to music
        (function() {
            const audioElement = document.getElementById('music-player');
            if (!audioElement) return;

            let audioContext = null;
            let analyser = null;
            let dataArray = null;

            // Pre-initialize audioData so animation.js can check it immediately
            window.audioData = { bass: 0, mids: 0, treble: 0, active: false };

            // Initialize audio context on first play (browser requirement)
            audioElement.addEventListener('play', async function initAudio() {
                if (!audioContext) {
                    try {
                        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                        console.log('1. AudioContextClass:', AudioContextClass);
                        console.log('2. typeof AudioContextClass:', typeof AudioContextClass);

                        if (!AudioContextClass) {
                            console.error('Web Audio API not supported');
                            return;
                        }

                        audioContext = new AudioContextClass();
                        console.log('3. audioContext:', audioContext);
                        console.log('4. audioContext type:', Object.prototype.toString.call(audioContext));
                        console.log('5. createMediaElementAudioSource exists:', typeof audioContext.createMediaElementAudioSource);

                        if (typeof audioContext.createMediaElementAudioSource !== 'function') {
                            console.error('createMediaElementAudioSource not available - trying alternative');
                            // Mark as initialized but skip audio analysis
                            audioContext = true;
                            return;
                        }

                        const source = audioContext.createMediaElementAudioSource(audioElement);
                        console.log('6. source created:', source);
                        analyser = audioContext.createAnalyser();
                        analyser.fftSize = 256;
                        analyser.smoothingTimeConstant = 0.7;

                        source.connect(analyser);
                        analyser.connect(audioContext.destination);

                        dataArray = new Uint8Array(analyser.frequencyBinCount);
                        console.log('Audio analyser initialized, buffer size:', dataArray.length);

                        // Start the update loop
                        function updateAudioData() {
                            analyser.getByteFrequencyData(dataArray);

                            // Calculate frequency bands with wider ranges
                            const bass = dataArray.slice(0, 10).reduce((a, b) => a + b, 0) / 10;
                            const mids = dataArray.slice(10, 80).reduce((a, b) => a + b, 0) / 70;
                            const treble = dataArray.slice(80, 128).reduce((a, b) => a + b, 0) / 48;

                            window.audioData = {
                                bass: bass,
                                mids: mids,
                                treble: treble,
                                active: !audioElement.paused
                            };

                            // Debug: log occasionally to verify data
                            if (Math.random() < 0.01) {
                                console.log('Audio data:', bass.toFixed(1), mids.toFixed(1), treble.toFixed(1));
                            }

                            requestAnimationFrame(updateAudioData);
                        }

                        updateAudioData();
                    } catch (err) {
                        console.error('Audio context init error:', err);
                    }
                }

                // Resume audio context if suspended (browser autoplay policy)
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                window.audioData = window.audioData || { bass: 0, mids: 0, treble: 0, active: true };
                window.audioData.active = true;
            });

            // Mark audio as inactive when paused
            audioElement.addEventListener('pause', () => {
                if (window.audioData) {
                    window.audioData.active = false;
                }
            });

            // Play button toggle
            const playBtn = document.getElementById('play-btn');
            const playIcon = playBtn.querySelector('.play-icon');
            const pauseIcon = playBtn.querySelector('.pause-icon');

            playBtn.addEventListener('click', () => {
                if (audioElement.paused) {
                    audioElement.play();
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                } else {
                    audioElement.pause();
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                }
            });

            audioElement.addEventListener('ended', () => {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            });
        })();
    </script>
    <script>
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.href && !this.href.includes('#')) {
                    e.preventDefault();
                    document.querySelector('.page-flash').classList.add('active');
                    setTimeout(() => { window.location.href = this.href; }, 150);
                }
            });
        });
    </script>
</body>
</html>
