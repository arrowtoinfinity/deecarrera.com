<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music - Daniel Carrera</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="styles.css?v=56">
</head>
<body class="subpage">
    <div class="page-flash"></div>
    <canvas id="constellation-bg"></canvas>
    <canvas id="constellation-fg"></canvas>
    <nav>
        <a href="/" class="nav-name">
            <img src="logo.png" alt="Logo" class="nav-logo">
            Daniel Carrera
        </a>
        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="nav-links" id="nav-links">
            <a href="/art.html" id="nav-art">Art</a>
            <a href="/literature.html" id="nav-literature">Literature</a>
            <a href="/music.html" id="nav-music" class="active">Music</a>
            <a href="/software.html" id="nav-software">Software</a>
            <a href="/hardware.html" id="nav-hardware">Hardware</a>
            <a href="/textiles.html" id="nav-textiles">Textiles</a>
        </div>
        <script>
            (function() {
                const settings = JSON.parse(localStorage.getItem('site_settings') || '{}');
                const navContainer = document.getElementById('nav-links');
                const navItems = ['art', 'literature', 'music', 'software', 'hardware', 'textiles'];

                navItems.forEach(key => {
                    const el = document.getElementById('nav-' + key);
                    const showKey = 'show' + key.charAt(0).toUpperCase() + key.slice(1) + 'Nav';
                    if (el && settings[showKey] === false) el.style.display = 'none';
                });

                if (settings.navOrder && navContainer) {
                    settings.navOrder.forEach(key => {
                        const el = document.getElementById('nav-' + key);
                        if (el) navContainer.appendChild(el);
                    });
                }
            })();
        </script>
    </nav>

    <main>
        <section class="page-header">
            <h1>Music</h1>
        </section>

        <section class="music-list" id="music-list"></section>
        <script>
            (function() {
                const TRACKS_KEY = 'music_tracks';
                const defaultTracks = [
                    { id: 'paradox', title: 'Paradox', file: 'Paradox.mp3', visibility: 'visible' }
                ];

                function getTracks() {
                    const data = localStorage.getItem(TRACKS_KEY);
                    const tracks = data ? JSON.parse(data) : defaultTracks;
                    return tracks.filter(t => t.visibility !== 'hidden');
                }

                const tracks = getTracks();
                const container = document.getElementById('music-list');

                if (tracks.length === 0) {
                    container.innerHTML = '<p class="content-placeholder">No tracks yet.</p>';
                    return;
                }

                // For now, render only the first visible track with the player
                const track = tracks[0];
                const isComingSoon = track.visibility === 'coming_soon';

                if (isComingSoon) {
                    container.innerHTML = `
                        <article class="music-card vertical content-coming-soon" id="${track.id}">
                            <div class="play-btn" style="opacity: 0.5; cursor: default;">
                                <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                            <h2>Coming Soon</h2>
                        </article>
                    `;
                } else {
                    container.innerHTML = `
                        <article class="music-card vertical" id="${track.id}">
                            <button class="play-btn" id="play-btn">
                                <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                                <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                                </svg>
                            </button>
                            <h2>${track.title}</h2>
                            <audio id="music-player" crossorigin="anonymous">
                                <source src="${track.file}" type="audio/mpeg">
                            </audio>
                        </article>
                    `;
                }

                // Scroll to hash if present
                if (window.location.hash) {
                    const target = document.querySelector(window.location.hash);
                    if (target) target.scrollIntoView({ behavior: 'smooth' });
                }
            })();
        </script>
    </main>

    <footer>
        <p>&copy; 2026 Daniel Carrera</p>
    </footer>
    <script src="animation.js"></script>
    <script>
        // Audio Visualizer - uses buffer-based approach to avoid SES/extension conflicts
        (function() {
            const playBtn = document.getElementById('play-btn');
            const playIcon = playBtn.querySelector('.play-icon');
            const pauseIcon = playBtn.querySelector('.pause-icon');
            const audioElement = document.getElementById('music-player');

            let audioContext = null;
            let analyser = null;
            let bufferSource = null;
            let audioBuffer = null;
            let dataArray = null;
            let isPlaying = false;
            let isLoading = false;
            let startTime = 0;
            let pauseTime = 0;

            // Pre-initialize audioData
            window.audioData = { bass: 0, mids: 0, treble: 0, active: false };

            // Load audio file as buffer (bypasses SES restrictions)
            async function loadAudioBuffer() {
                if (audioBuffer) return audioBuffer;

                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!audioContext) {
                    audioContext = new AudioContextClass();
                }

                // Fetch the audio file
                const response = await fetch('Paradox.mp3');
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                console.log('Audio buffer loaded, duration:', audioBuffer.duration);

                // Setup analyser - minimal smoothing for instant response
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.3; // Lower = faster response
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                return audioBuffer;
            }

            // Start audio analysis loop
            function startAnalysisLoop() {
                function updateAudioData() {
                    if (!isPlaying || !analyser) {
                        window.audioData.active = false;
                        return;
                    }

                    analyser.getByteFrequencyData(dataArray);

                    // Frequency bands tuned for THIS song:
                    // Low (345 Hz area): bins 1-2
                    // High (517-1200 Hz): bins 3-7 - expanded range for more reactivity
                    const low = (dataArray[1] + dataArray[2]) / 2;
                    const high = (dataArray[3] + dataArray[4] + dataArray[5] + dataArray[6] + dataArray[7]) / 5;

                    window.audioData = {
                        low: low,
                        high: high,
                        active: true
                    };

                    // Debug: see which frequencies are active
                    if (Math.random() < 0.03) {
                        console.log('LOW:', low.toFixed(0), '| HIGH:', high.toFixed(0));
                    }

                    requestAnimationFrame(updateAudioData);
                }
                updateAudioData();
            }

            // Play audio
            async function playAudio() {
                if (isLoading) return;
                isLoading = true;

                try {
                    await loadAudioBuffer();

                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }

                    // Create new buffer source (required for each play)
                    bufferSource = audioContext.createBufferSource();
                    bufferSource.buffer = audioBuffer;
                    bufferSource.connect(analyser);
                    analyser.connect(audioContext.destination);

                    // Handle end of audio
                    bufferSource.onended = () => {
                        if (isPlaying) {
                            isPlaying = false;
                            pauseTime = 0;
                            window.audioData.active = false;
                            playIcon.style.display = 'block';
                            pauseIcon.style.display = 'none';
                        }
                    };

                    // Start from pause position
                    bufferSource.start(0, pauseTime);
                    startTime = audioContext.currentTime - pauseTime;
                    isPlaying = true;

                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';

                    startAnalysisLoop();
                    isLoading = false;
                    console.log('Playing from:', pauseTime.toFixed(2));
                } catch (err) {
                    console.error('Play error:', err);
                    isLoading = false;
                }
            }

            // Pause audio
            function pauseAudio() {
                // Always update UI first
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                window.audioData.active = false;

                if (bufferSource) {
                    try {
                        pauseTime = audioContext.currentTime - startTime;
                        bufferSource.stop();
                        bufferSource.disconnect();
                    } catch (e) {
                        // Already stopped
                    }
                    bufferSource = null;
                }
                isPlaying = false;
                console.log('Paused at:', pauseTime.toFixed(2));
            }

            // Toggle play/stop - stop resets to beginning, play always starts fresh
            playBtn.addEventListener('click', () => {
                if (isPlaying) {
                    pauseAudio();
                    pauseTime = 0; // Reset to beginning when stopped
                } else {
                    pauseTime = 0; // Always start from beginning
                    playAudio();
                }
            });

            // Preload audio buffer on page load for instant playback
            loadAudioBuffer().then(() => {
                console.log('Audio preloaded and ready');
            }).catch(err => {
                console.log('Preload skipped (will load on first play):', err.message);
            });
        })();
    </script>
    <script>
        // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        const navLinksEl = document.getElementById('nav-links');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navLinksEl.classList.toggle('active');
        });

        // Page transition
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.href && !this.href.includes('#')) {
                    e.preventDefault();
                    document.querySelector('.page-flash').classList.add('active');
                    setTimeout(() => { window.location.href = this.href; }, 150);
                }
            });
        });
    </script>
</body>
</html>
